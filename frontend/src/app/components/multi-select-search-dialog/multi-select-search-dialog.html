<div class="dialog-header">
    <div class="header-icon">
        <mat-icon>library_music</mat-icon>
    </div>
    <div class="header-content">
        <h2 mat-dialog-title>Alben suchen & hinzufügen</h2>
        <p class="header-subtitle">Suche nach Alben auf Spotify und füge sie deiner Sammlung hinzu</p>
    </div>
</div>

<mat-dialog-content>
    <div class="search-container">
        <mat-form-field appearance="outline" class="search-field">
            <mat-label>Spotify durchsuchen</mat-label>
            <input matInput [formControl]="searchControl" placeholder="Album- oder Künstlername">
            <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>
    </div>

    @if (isLoading()) {
    <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
    </div>
    }

    <div class="table-container">
        <table mat-table [dataSource]="searchResults()" multiTemplateDataRows class="search-table">

            <!-- Image Column -->
            <ng-container matColumnDef="image">
                <th mat-header-cell *matHeaderCellDef> Cover </th>
                <td mat-cell *matCellDef="let element">
                    <img [src]="element.coverUrl" class="table-cover">
                </td>
            </ng-container>

            <!-- Title Column -->
            <ng-container matColumnDef="title">
                <th mat-header-cell *matHeaderCellDef> Titel </th>
                <td mat-cell *matCellDef="let element"> {{element.title}} </td>
            </ng-container>

            <!-- Artist Column -->
            <ng-container matColumnDef="artist">
                <th mat-header-cell *matHeaderCellDef> Künstler </th>
                <td mat-cell *matCellDef="let element"> {{element.artist || '-'}} </td>
            </ng-container>

            <!-- Type Column -->
            <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef> Typ </th>
                <td mat-cell *matCellDef="let element">
                    <span class="type-badge" [ngClass]="element.type">{{element.type | titlecase}}</span>
                </td>
            </ng-container>

            <!-- Rooms Column -->
            <ng-container matColumnDef="rooms">
                <th mat-header-cell *matHeaderCellDef> Räume </th>
                <td mat-cell *matCellDef="let element">
                    @if (isSelected(element)) {
                    <mat-chip-set class="room-chips">
                        @for (room of getAlbumRooms(element); track room) {
                        <mat-chip class="room-chip" [style.background-color]="getRoomColor(room)" [matTooltip]="room"
                            matTooltipPosition="above">
                            {{ getRoomSymbol(room) }}
                        </mat-chip>
                        }
                    </mat-chip-set>
                    }
                </td>
            </ng-container>

            <!-- Action Column -->
            <ng-container matColumnDef="action">
                <th mat-header-cell *matHeaderCellDef> Aktion </th>
                <td mat-cell *matCellDef="let element">
                    @if (element.type === 'album') {
                    <button mat-icon-button (click)="toggleSelection(element, $event)"
                        [color]="isSelected(element) ? 'primary' : ''" [disabled]="isAlreadyAdded(element)">
                        <mat-icon>{{ isSelected(element) || isAlreadyAdded(element) ? 'check_circle' :
                            'add_circle_outline' }}</mat-icon>
                    </button>
                    } @else {
                    <mat-icon class="expand-icon" [class.expanded]="expandedElement() === element">
                        expand_more
                    </mat-icon>
                    }
                </td>
            </ng-container>

            <!-- Expanded Detail Row -->
            <ng-container matColumnDef="expandedDetail">
                <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length">
                    <div class="element-detail"
                        [@detailExpand]="element == expandedElement() ? 'expanded' : 'collapsed'">

                        @if (element == expandedElement()) {
                        <div class="detail-content">
                            @if (isChildrenLoading(element)) {
                            <div style="display: flex; justify-content: center; padding: 20px;">
                                <mat-spinner diameter="30"></mat-spinner>
                            </div>
                            } @else {
                            @if (getChildren(element).length > 0) {
                            <div class="detail-header">
                                <button mat-stroked-button color="primary" class="small-btn"
                                    (click)="selectAllChildren(element, $event)">
                                    Alle geladenen auswählen
                                </button>
                                <span class="detail-count">{{getChildren(element).length}} Alben</span>
                            </div>
                            }

                            <div class="child-list">
                                @for (child of getChildren(element); track child.id || child.uri) {
                                <div class="child-row" [class.selected]="isSelected(child)"
                                    [class.already-added]="isAlreadyAdded(child)"
                                    (click)="toggleSelection(child, $event)">

                                    <img [src]="child.coverUrl" class="child-cover">

                                    <div class="child-info">
                                        <div class="child-main">
                                            <span class="child-title">{{child.title}}</span>
                                            @if (isSelected(child)) {
                                            <mat-chip-set class="room-chips child-room-chips">
                                                @for (room of getAlbumRooms(child); track room) {
                                                <mat-chip class="room-chip"
                                                    [style.background-color]="getRoomColor(room)" [matTooltip]="room"
                                                    matTooltipPosition="above">
                                                    {{ getRoomSymbol(room) }}
                                                </mat-chip>
                                                }
                                            </mat-chip-set>
                                            }
                                        </div>

                                        <div class="child-actions">
                                            @if (isAlreadyAdded(child)) {
                                            <span
                                                style="color: grey; font-size: 12px; margin-right: 8px;">Hinzugefügt</span>
                                            }
                                            <mat-icon [color]="isSelected(child) ? 'primary' : ''"
                                                style="font-size: 20px; height: 20px; width: 20px;">
                                                {{ isSelected(child) || isAlreadyAdded(child) ? 'check_circle' :
                                                'add_circle_outline' }}
                                            </mat-icon>
                                        </div>
                                    </div>
                                </div>
                                }
                            </div>
                            @if (getChildren(element).length === 0 && !isChildrenLoading(element)) {
                            <div class="no-children" style="padding: 16px; text-align: center; color: #888;">Keine Alben
                                gefunden.</div>
                            }
                            }
                        </div>
                        }
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="columnsToDisplay; sticky: true"></tr>

            <tr mat-row *matRowDef="let element; columns: columnsToDisplay;" class="element-row"
                [class.expandable-row]="element.type !== 'album'" (click)="toggleRow(element)">
            </tr>

            <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
        </table>

        @if (searchResults().length === 0 && !isLoading() && searchControl.value?.length! > 1) {
        <div class="no-results">Keine Ergebnisse gefunden.</div>
        }
    </div>
</mat-dialog-content>

<mat-dialog-actions>
    <div class="actions-left">
        <!-- Bulk Room Selection -->
        @if (selectedAlbums().size > 0) {
        <mat-form-field appearance="outline" class="bulk-room-field" subscriptSizing="dynamic">
            <mat-label>Standard-Räume für Auswahl</mat-label>
            <mat-select [value]="defaultRooms()" (selectionChange)="defaultRooms.set($event.value)" multiple>
                @for (room of rooms(); track room.name) {
                <mat-option [value]="room.name">{{ room.name }}</mat-option>
                }
            </mat-select>
            <mat-icon matPrefix>room</mat-icon>
        </mat-form-field>
        }
    </div>

    <div class="actions-right">
        <button mat-button (click)="selectAll()">Alles auswählen</button>
        <button mat-button (click)="close()">Abbrechen</button>
        <button mat-flat-button color="primary" [disabled]="selectedAlbums().size === 0" (click)="addSelected()">
            <mat-icon>add</mat-icon>
            Auswahl hinzufügen ({{ selectedAlbums().size }})
        </button>
    </div>
</mat-dialog-actions>